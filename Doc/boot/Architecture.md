# ЁЯза CPU Architecture Detection & Boot Flow (Stage-based Design)

## ЁЯФН Overview

Bootloader р╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╕Щр╕╡р╣Йр╕бр╕╡р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕Ър╕Ъ 3-stage р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕лр╕ер╕▓р╕вр╕кр╕Цр╕▓р╕Ыр╕▒р╕Хр╕вр╕Бр╕гр╕гр╕бр╕Чр╕▒р╣Йр╕З x86, x86_64 р╣Бр╕ер╕░ ARM р╣Вр╕Фр╕вр╕бр╕╡р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ CPUID р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕вр╕Б flow р╕Вр╕нр╕Зр╕Бр╕▓р╕гр╕Ър╕╣р╕Хр╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕лр╕бр╕▓р╕░р╕кр╕бр╕Бр╕▒р╕Ъ CPU р╕Чр╕╡р╣Ир╕Хр╕гр╕зр╕Ир╕Юр╕Ъ

---

## ЁЯкЬ Boot Flow Summary

### Stage 1: Initial Bootloader (`@ 0x7C00`)

- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ CPU р╕гр╕нр╕Зр╕гр╕▒р╕Ъ `CPUID` р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
  - тЭМ р╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ тЖТ р╕Цр╕╖р╕нр╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ ARM тЖТ Jump р╣Др╕Ы `0xA000`
  - тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ тЖТ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Long Mode:
    - тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ Long Mode тЖТ `cpu_mode = 1 (x86_64)` тЖТ р╣Вр╕лр╕ер╕Ф Stage 3 р╕Чр╕╡р╣И `0x90000` тЖТ `jmp 0x9000`
    - тЭМ р╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ тЖТ `cpu_mode = 2 (x86)` тЖТ р╣Вр╕лр╕ер╕Ф Stage 2 р╕Чр╕╡р╣И `0x8000` тЖТ `jmp 0x8000`

---

### Stage 2: Protected Mode Setup (`@ 0x8000`)

- р╕нр╣Ир╕▓р╕Щ `cpu_mode` р╕Ир╕▓р╕Б `0x7FF0`
- р╕Бр╕гр╕Ур╕╡:
  - `1` тЖТ р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Ар╕Вр╣Йр╕▓ 64-bit Mode:
    - р╣Вр╕лр╕ер╕Ф Stage 3 (`0x90000`) р╕Ир╕▓р╕Б LBA sector 32
    - р╣Ар╕Ыр╕┤р╕Ф A20 Line тЖТ Jump р╣Др╕Ы `0x9000`
  - `2` тЖТ р╣Ар╕Хр╕гр╕╡р╕вр╕б Protected Mode (x86 32-bit):
    - р╣Вр╕лр╕ер╕Ф Kernel р╕Ир╕▓р╕Б LBA sector 8 тЖТ `0x10000`
    - р╕Хр╕▒р╣Йр╕З GDT, р╣Ар╕Ыр╕┤р╕Ф CR0 тЖТ Jump р╣Др╕Ы `protected_mode_entry`
  - р╕нр╕╖р╣Ир╕Щр╣Ж тЖТ р╣Бр╕кр╕Фр╕З "Unsupported Architecture" тЖТ Halt

---

### Stage 3: Long Mode Setup (`@ 0x9000`)

- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ A20 Line тЖТ р╣Ар╕Ыр╕┤р╕Фр╕лр╕▓р╕Бр╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Ар╕Ыр╕┤р╕Ф
- р╣Вр╕лр╕ер╕Ф Kernel (р╣Гр╕Кр╣Й LBA р╕лр╕гр╕╖р╕н fallback р╣Ар╕Ыр╣Зр╕Щ CHS)
- р╕кр╕гр╣Йр╕▓р╕З Paging Structures (PML4, PDPT, PD)
- р╣Ар╕Ыр╕┤р╕Ф Long Mode:
  - `CR4.PAE = 1`
  - `EFER.LME = 1`
  - `CR0 |= PG | PE`
- Jump р╣Др╕Ы `0x100000` тЖТ р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣И 64-bit Kernel

---

## ЁЯФз Detailed Boot Decision Table

| Stage | р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣И   | р╕Ир╕╕р╕Фр╕Чр╕│р╕Зр╕▓р╕Щр╕лр╕ер╕▒р╕Б                                                      |
|-------|----------|---------------------------------------------------------------------|
| 1     | 0x7C00   | р╕Хр╕гр╕зр╕И CPUID тЖТ р╕Хр╕▒р╕Фр╕кр╕┤р╕Щр╣Гр╕Ир╣Ар╕Вр╣Йр╕▓ Stage 2 р╕лр╕гр╕╖р╕н Stage 3 р╕лр╕гр╕╖р╕н ARM             |
| 2     | 0x8000   | р╣Ар╕Хр╕гр╕╡р╕вр╕б Protected Mode р╕лр╕гр╕╖р╕н Long Mode р╣Бр╕ер╕░р╣Вр╕лр╕ер╕Ф Kernel р╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕б       |
| 3     | 0x9000   | р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Paging + GDT тЖТ р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣И Long Mode (64-bit) р╣Бр╕ер╕░р╣Ар╕гр╕┤р╣Ир╕б Kernel     |

---

## ЁЯУЭ р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕

- р╣Гр╕Кр╣Й `INT 13h AH=42h` р╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╣Ир╕▓р╕Щ Disk р╣Бр╕Ър╕Ъ LBA (fallback р╣Ар╕Ыр╣Зр╕Щ CHS)
- р╣Ар╕Ыр╕┤р╕Ф A20 Line р╕Фр╣Йр╕зр╕в Fast A20 (`port 0x92`)
- р╣Гр╕Кр╣Й BIOS `INT 10h` р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
- GDT р╕Цр╕╣р╕Бр╕Ир╕▒р╕Фр╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Гр╕лр╣Йр╣Ар╕ер╣Зр╕Бр╣Бр╕ер╕░р╣Ар╕лр╕бр╕▓р╕░р╕Бр╕▒р╕Ър╣Вр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ (PM/LM)

---

## ЁЯФЧ р╕кр╕Цр╕▓р╕Ыр╕▒р╕Хр╕вр╕Бр╕гр╕гр╕бр╕Чр╕╡р╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ

- тЬЕ x86 (Real Mode тЖТ Protected Mode)
- тЬЕ x86_64 (Real Mode тЖТ Protected Mode тЖТ Long Mode)
- ЁЯзк ARM / AArch64 (р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Бр╕Ьр╕Щр╕гр╕нр╕Зр╕гр╕▒р╕Ъ р╣Вр╕Фр╕вр╣Гр╕Кр╣Й fallback р╕лр╕▓р╕Б CPUID р╣Др╕бр╣Ир╕бр╕╡)

---

## ЁЯУМ р╕ар╕▓р╕Юр╕гр╕зр╕б Flow р╕кр╕▒р╣Йр╕Щ

```plaintext
Stage 1 (0x7C00)
 тФЬтФАтФА р╕Цр╣Йр╕▓ CPUID р╣Др╕бр╣Ир╕бр╕╡ тЖТ ARM тЖТ jmp 0xA000
 тФФтФАтФА р╕Цр╣Йр╕▓ CPUID р╕бр╕╡
      тФЬтФАтФА р╕Цр╣Йр╕▓р╕бр╕╡ Long Mode тЖТ cpu_mode=1 тЖТ Stage 3 @ 0x90000
      тФФтФАтФА р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡ Long Mode тЖТ cpu_mode=2 тЖТ Stage 2 @ 0x8000

Stage 2 (0x8000) тЖР x86 (32-bit)
 тФФтФАтФА р╣Ар╕Хр╕гр╕╡р╕вр╕б GDT тЖТ р╣Ар╕Ыр╕┤р╕Ф PE тЖТ р╣Вр╕лр╕ер╕Ф Kernel @ 0x100000 тЖТ jmp EIP=0x100000

Stage 3 (0x9000) тЖР x86_64
 тФФтФАтФА р╕кр╕гр╣Йр╕▓р╕З PML4 тЖТ р╣Ар╕Ыр╕┤р╕Ф CR4.PAE, CR0.PG, EFER.LME тЖТ jmp RIP=0x100000
